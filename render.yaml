services:
  - type: web
    name: road-pothole-detector
    env: python
    plan: free
    buildCommand: |
      pip install --upgrade pip
      pip install -r requirements.txt
      echo "=== Checking for SAM model ==="
      ls -lh sam_vit_b_01ec64.pth || echo "SAM model not found"
      if [ ! -f sam_vit_b_01ec64.pth ] || [ $(stat -c%s sam_vit_b_01ec64.pth 2>/dev/null || echo 0) -lt 375000000 ]; then
        echo "=== Downloading SAM model ==="
        curl -L --progress-bar -o sam_vit_b_01ec64.pth "https://dl.fbaipublicfiles.com/segment_anything/sam_vit_b_01ec64.pth" || echo "Download failed, will retry at runtime"
      else
        echo "=== SAM model already present ==="
      fi
      ls -lh sam_vit_b_01ec64.pth || echo "No SAM model"
    startCommand: gunicorn --worker-class eventlet --workers 1 --bind 0.0.0.0:$PORT app:app
    envVars:
      - key: PYTHON_VERSION
        value: 3.11.9
      - key: FLASK_ENV
        value: production
      - key: SECRET_KEY
        generateValue: true
      - key: WEB_CONCURRENCY
        value: 1
      - key: DB_HOST
        value: dpg-d3su87c9c44c73cdki1g-a.oregon-postgres.render.com
      - key: DB_PORT
        value: "5432"
      - key: DB_NAME
        value: distress_db
      - key: DB_USER
        value: distress_db_user
      - key: DB_PASSWORD
        value: xZLgwESqa0z9OeMtZiAlYbidFQqLHDMv
      - key: UPLOAD_FOLDER
        value: uploads
      - key: MAX_CONTENT_LENGTH
        value: "16777216"
